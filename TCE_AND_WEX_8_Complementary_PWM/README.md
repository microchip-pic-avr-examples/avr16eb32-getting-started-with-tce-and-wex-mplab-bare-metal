[![MCHP](../images/microchip.png)](https://www.microchip.com)

## Use case 3: Generate 8 complementary PWM signals using TCE and WEX

Below is an example of how to set a TCE and a WEX instance to generate 8 complementary PWM signals at 20 kHz with variable duty cycles using the buffering. The signals are in pairs of two and are not overlapping due to the added dead time, a feature which is essential in motor control for avoiding the shoot-through current in transistor switching. The update of the compare registers will happen during the compare match interrupts for each channel. In this example the fault is highlighted as well. When a software event is triggered all the signals are driven low. This happens every 250μs. In order to do this, the WEX must be configured for fault detection and the EVSYS must be configured to generate a software event. In this example the WEX module is used as a timer extension, not in Pattern Generation mode.

## Related Documentation

More details and code examples on the AVR16EB32 can be found at the following links:

- [AVR<sup>®</sup> EB Product Page](https://www.microchip.com/en-us/product/AVR16EB32)
- [AVR<sup>®</sup> EB Code Examples on GitHub](https://github.com/microchip-pic-avr-examples?q=AVR16EB32)

## Software Used

- [MPLAB® X IDE v6.15 or newer](https://www.microchip.com/en-us/tools-resources/develop/mplab-x-ide)
- [AVR-Ex DFP-2.7.184 or newer Device Pack](https://packs.download.microchip.com/)
- [MPLAB® XC8 compiler v2.45](https://www.microchip.com/en-us/tools-resources/develop/mplab-xc-compilers/downloads-documentation#XC8)

## Hardware Used

- [AVR<sup>®</sup> EB Curiosity Nano](https://www.microchip.com/en-us/product/AVR16EB32)

## Setup

The AVR16EB32 Curiosity Nano Development Board is used as a test platform.

<br><img src="../images/AVR16EB32_Cnano_Board.png">

## Functionality

After the peripheral clock, the output port pins, TCE, WEX, Event System are configured and the global interrupts are enabled, the ```Create_Fault``` and ```Clear_Fault``` functions are called in an infinite loop. The first function create a software fault that drives all the output port pins to low '0' logic. WEX's fault handling mechanism is configured in latched mode. This means that the fault can be cleared if the fault condition is not active anymore and a software clear command is given. The second function clears the fault and restart the normal operation of TCE. First the fault is triggered, than fault is mantained using a delay of 250μs. After that delay, the fault is cleared and TCE is working normally for another 250μs. After that, another fault is triggered and the process repeats over and over again. TCE is configured in Single Slope mode and is running at 20KHz. TCE generates 4 PWM signals with different duty cycles that are updated in ISR routines. WEX is configured to be an extension for the TCE and to generate complementary signals with dead time for the ones generated by TCE. WEX is also configured to handle faults. Event System is configured to send software events to WEX.

## Function that is called in an infinite loop

```c
void Create_Fault(void)
{
    /* Fault creation, repeat in main loop to see it on Logic Analyzer. This is an event generated using a software command */
    EVSYS.SWEVENTA = EVSYS_SWEVENTA_CH0_gc;
}

void Clear_Fault(void)
{
    /* Clear fault condition using a software command */
    WEX0.CTRLC = WEX_CMD_FAULTCLR_gc;
}
```

<br><img src="../images/tce_wex_fault_flowchart.png">

## Operation

 1. Connect the board to the PC.

 2. Open the **TCE_AND_WEX_8_Complementary_PWM_MCC.X** or **TCE_AND_WEX_8_Complementary_PWM.X** solution in MPLAB X IDE.

 3. Right click on the project and select **Set as main project**.

<br><img src="../images/Set_as_main_project3.png">

 4. Build the **TCE_AND_WEX_8_Complementary_PWM_MCC.X** or **TCE_AND_WEX_8_Complementary_PWM.X** project: click on **Clean and Build Project**.

<br><img src="../images/Clean_and_build3.png">

 5. Program the project to the board: click on **Make and Program Device**.

<br><img src="../images/Program_board3.png">

## Results

Below is illustrated a logic analyzer capture, to help understanding a little bit better how the WEX generates a complementary waveform signal for each PWM signal generated by TCE and how does the fault handling work in hardware:

<br>The range of the duty cycles is 0-100% of the PERIOD minus the value of dead time added.

<br><img src="../images/usecase3_dcy_fault.png">

## Summary

This project shows how to use the WEX and TCE to generate complementary PWM signals and how to use the fault feature of WEX. Using TCE and WEX can generate up to 8 PWM signals complementary in 4 independent pairs.